\section{Трекинг на основе особых точек и цвета}

\subsection{Трекинг на основе точечных особенностей изображения}

Применяемый в данной работе алгоритм трекинга с помощью точечных особенностей
представляет собой разновидность стандартного подхода "--- трекера
Канаде "--- Лукаса "--- Томаси
(KLT-трекера)\cite{LucasAndKanade,TomasiAndKanade,ShiAndTomasi,PyrLK}.
На кадрах с известной позицией объекта выделяются ключевые 2D-точки (точечные
особенности) и определяются соответствующие им 3D-точки на поверхности модели.
Движение ключевых точек отслеживается с помощью вычисления оптического потока.
На кадре, для которого выполняется оценка позиции, по известным 2D-3D
соответствиям вычисляется позиция объекта путем решения задачи
\PnP\cite{LepetitSurvey} с использованием RANSAC\cite{RANSAC} для отсеивания
выбросов.

\Comment{TODO: нужно ли описывать подробнее и рассказывать про улучшения
в виде фильтрации точек?}

\subsection{Метод на основе распределения цвета}

\Comment{TODO: нужно все, что касается чужих методов и их сравнения между
собой перевести в related work без формул, а тут оставить в первую очередь
описание метода, о котором идет речь в статье.}

Метод, использующий распределение цветов основан на построении цветовых
гистограмм, впервые предложенных для трекинга в \cite{Bibby2008}.
По первому изображению, на котором позиция объекта известна, строятся
гистограммы распределения цветов $H_f$ и $H_b$ для маски и для фона
соответственно.
Гистограммы строятся таким образом, чтобы значения в каждом канале разбивались
на 32 ячейки, поэтому в этой главе под цветом пикселя $y$ будем понимать
множество цветов, попадающих в одну ячейку гистограммы: $y \in [0; 31]^3$.
В каждую ячейку гистограммы $H_i$ записывается доля пикселей соответствующих
цветов на области $\Omega_i$ ($i = \{f, b\}$).

В алгоритме PWP3D \cite{PWP3D} используется функция ошибки для позиции, которая
основана на апостериорной вероятности позиции при данном изображении и данном
наборе гистограмм.
Пусть дан новый кадр и некоторая позиция $T$.
Спроецируем объект на изображение с использованием этой позиции.
Получим разбиение изображения на области $\Omega_f$ и $\Omega_b$.
Тогда вероятность того, что $T$
является позицией объекта
$
    P(T) = \prod\limits_{x \in \Omega}(\mathbb{P}(x \in Fg | H_f, H_b)\mathbb{P}(x \in Fg | T) +$ $\mathbb{P}(x \in Bg|H_f, H_b)\mathbb{P}(x \in Bg | T))
$

% TODO: pose enhancement

Здесь $Fg$ - маска проекции, $Bg$ - фон

Тогда
\begin{equation*}
    \mathbb{P}(x \in Fg | T) = 
     \begin{cases}
       1 &x \in \Omega_f\\
       0 &x \in \Omega_b
     \end{cases}
\end{equation*}

Для того, чтобы функция непрерывно зависела от параметров трансформации,
используют приближённую функцию Хевисайда:
$$
    \mathbb{P}(x \in Fg | T) = He(\Phi(x))
$$ 

$$
    \mathbb{P}(x \in Bg | T) = 1 - He(\Phi(x))
$$

Так как гистограммы влияют на принадлежность точки проекции только основываясь
на её цвете,
$\mathbb{P}(x \in Fg | H_f, H_b)$
может оцениваться как
$\mathbb{P}(x \in Fg | I(x) = y)$

В PWP3D

$
    \mathbb{P}(x \in Fg | I(x) = y) = \frac{H_f(y)}{\mathbb{P}(I(x) = y)}
$

$
    \mathbb{P}(x \in Bg | I(x) = y) = \frac{H_b(y)}{\mathbb{P}(I(x) = y)}
$,

где

$
    \mathbb{P}(I(x) = y) = \eta_f H_f(y) + \eta_b H_b(y)
$

$
    \eta_f = \sum\limits_{x \in \Omega}He(\Phi(x))
$

$
    \eta_b = \sum\limits_{x \in \Omega}(1 - He(\Phi(x)))
$

В предлагаемой реализации

$
    \mathbb{P}(x \in Fg | I(x) = y) = \frac{\mathbb{P}(I(x) = y | x \in Fg) \mathbb{P}(x \in Fg)}{\mathbb{P}(I(x) = y)} = \frac{H_f(y)\frac{\eta_f}{\eta_b}}{\mathbb{P}(I(x) = y)}
$

$
    \mathbb{P}(x \in Bg | I(x) = y) = 1 - \mathbb{P}(x \in Fg | I(x) = y)
$.

Далее функция ошибки определяется как
$
    E(\xi) = \sum\limits_{x \in \Omega}\log(He(\Phi(x))\mathbb{P}(x \in Fg | H_f, H_b) + (1 - He(\Phi(x)))\mathbb{P}(x \in Bg|H_f, H_b))
$

После получения новой позиции на каждом следующем кадре строятся новые
гистограммы, которые взвешенно суммируются со старыми: 

$
    H_{f} = \alpha_f H_{f}^{new} + (1 - \alpha_f) H_f^{old}
$

$
    H_{f} = \alpha_b H_{b}^{new} + (1 - \alpha_b) H_b^{old}
$, 

где $\alpha_f = 0.1, \alpha_b = 0.2$ - коэффициенты "забывания".

Чтобы получить оптимальную матрицу трансформации, нужно минимизировать функцию
энергии.
В \cite{Tjaden2018} выведена формула якобиана этой функции, с помощью которого
она минимизируется алгоритмом Гаусса-Ньютона.
В предлагаемой реализации использовался метод последовательного квадратичного
программирования (ссылка), который более устойчив к зашумлённым функциям, хотя
и дольше работает. \Comment{Откуда взято, что SLSQP более устойчив к чему-то,
но дольше работает?}

Минимизация проводится на пирамиде изображений высотой 3 (ссылка?).
\Comment{Вот это вообще не понятно и надо описывать хотя бы минимально}.

\Comment{TODO: описать то, как выбираются гистограммы.}

Одним из недостатков подхода, основанного на распределении цветов, является
неустойчивость к изменению освещения.
Для того, чтобы сделать трекинг устойчивым к таким условиям, изображение
переводится в формат HSV и затем проводится эквилизация гистограмм (ссылка?).
Это ликвидирует изменчивость освещения и может улучшить трекинг в тёмных
сценах, так как в среднем яркость изображения в таких случаях увеличивается.
\Comment{Нужны какие-то внятные объяснения, пока что звучит весьма
сомнительно.}

\subsection{Комбинирование методов}

\Comment{Скорее всего имеет смысл оставить тот вариант, который лучше работает}

\subsubsection{Последовательное применение алгоритмов}

Первый способ скрещивания алгоритмов заключается в последовательном их
применении и инициализации одного метода другим.
Метод на основе распределения цветов требует пересчёта большого количества
гистограмм и использования их при каждом вычислении функции ошибки и градиента,
поэтому является более вычислительно сложным, чем метод ключевых точек, поэтому
для скорости трекинга важно сократить количество итераций, за которое он
сходится.

Позиции объекта на видео определяются последовательно, от кадра к кадру.
Введём обозначения:

$F_{feat}(I)$ -- результат работы алгоритма ключевых точек на изображении $I$; 

$F_{color}(T, I)$ -- результат работы цветового алгоритма на изображении $I$
при инициализации его позицией $T$;

$E_{color}(T)$ -- функция энергии цветового алгоритма от позиции $T$.

Тогда при обработке $i$-ого кадра проводится следующая последовательность
действий:

\begin{enumerate}
\item Чтение изображения $I_i$
\item Вычиление позиции алгоритмом ключевых точек:
    $T_{feat}^{(i)} = F_{feat}(I_i)$
\item Уточнение позиции цветовым методом:
    $T^{(i)} = F_{color}(T_{feat}, I_i)$
\item Вычисление  3D-позиций, соответствующих ключевым особенностям с
    использованием позиции $T^i$
\end{enumerate}

После получения изображения проиходит вычисление позиции $T_{feat}$ алгоритмом
ключевых точек, описанным в главе 2.2. % TODO: ref
Чаще всего эта позиция близка к глобальному минимуму функции энергии цветового
алгоритма, но если метод ключевых точек отработал плохо (например из-за
смазанности изображения), то эта позиция может оказаться далеко от оптимума, и
из-за этого цветовой алгоритм может не сойтись.
Чтобы избежать таких случаев, предусмотрен альтернативный способ инициализации
позиции.

Наиболее естественный способ инициализировать алгоритм трекинга при отсутствии
специального метода инициализации -- это взять позицию с предыдущего кадра.
Но очень часто неправильная работа трекинга на ключевых точках вызвана
смазанностью при быстром движении объекта.
Чтобы учесть это движение, мы вычисляем альтернативную позицию экстраполяцией
движения с предыдущих кадров:
$
    T^{(i)}_{ex} = \Delta T T^{(i - 1)} = T^{(i - 1)}(T^{(i - 2)})^{-1} T^{(i - 1)}
$.

Алгоритм цветового трекинга сам выбирает, какую позицию использовать для
инициализации.
Выбирается та из них, на которой функция энергии цветового
алгоритма будет меньше.
$
    T_{color_init} = argmin(E_{color}(T_{feat}), E_{color}(T_{ex}))
$.

Чтобы этот выбор не занимал слишком много времени, вычисление $E_{color}$ здесь
проводится на 1\% гистограмм.

Для каждой отслеживаемой ключевой особенности известна её 3D-позиция на
объекте.
Для ключевых особенностей, которые впервые появились на текущем кадре,
требуется эту позицию найти.
Так как матрица трансформации, полученная цветовым алгоритмом, считается
уточнением матрицы, полученной алгоритмом ключевых точек, именно она
используется для восстановления 3D-позиций.

\Comment{TODO: процесс восстановления 3D-позиций?}

Для точечных особенностей, которые присутствовали и на предыдущих кадрах,
3D-позиция на объекте известна.
Однако то положение объекта, на котором она была вычислена, могло оказаться
неверным, и тогда 3D-позиция точки также вычислено неправильно.
Эта ошибка сохраняется в течение всего времени, пока данная точечная
особенность отслеживается.
Чтобы уточнить такие 3D-точки, все они пересчитываются на новом кадре, и если
новая позиция оказалась лучше, то она заменяет старую.

Чтобы определить, какая позиция лучше, нужно оценить ошибку репроекции для
каждой позиции.
Но ошибка репроекции будет нулевой для кадра, по которому позиция вычислена,
поэтому нужно выбрать какой-то кадр, на котором обе ошибки будут отличны от
нуля.
Вопрос об обновлении позиции откладывается до следующего кадра, и решается уже
по репроекции на нём.

Пусть $T_{old}$ - трансформация, на которой была вычислена позиция $X_{old}$,
$T_{new}$ - трансформация, на которой была вычислена позиция
$X_{new}$, $new > old$.

Пусть $x_0$ - позиция точечной особенности на изображении $new + 1$. 

Тогда $x_{old} = \pi (K (T_{new + 1})_{3 \times 4} X_{old})$

$x_{new} = \pi (K (T_{new + 1})_{3 \times 4} X_{new})$

$e_{old} = \| x_{old} - x_0 \|$

$e_{new} = \| x_{new} - x_0 \|$

При $e_{new} < e_{old}$ позиция $X_{old}$ заменяется на $X_{new}$.

\subsubsection{Совместная оптимизация}

Метод цветового трекинга, описанный в главе 2.3, основан на минимизации функции
энергии и максимизирует апостериорную вероятность позиции при данных
изображении и наборе гистограмм.
Имея информацию о расположении ключевых точек на изображении и об их прообразах
на объекте, естественно включить эту информацию в оценку вероятности позиции.

Функция энергии для алгоритма ключевых точек вводится таким образом, чтобы
максимизировать правдоподобие позиции при известной конфигурации ключевых точек
на изображении (ссылка).

Пусть на данном изображении найдено $n$ ключевых точек $x_1, ..., x_n$, для
которых на предыдущих кадрах были вычислены прообразы на объекте
$X_1, ..., X_n$. 

Спроецировав точки $X_1, ..., X_n$ из некоторой позиции $T$, получим набор
точек на плоскости $x'_1, ..., x'_n$, которые могут отличаться от точек
$x_1, ..., x_n$.

Вероятность величины этого различия по каждой координате будем считать
соответствующей нормальному распределению

$
    \mathbb{P}(x_{i_1} - x'_{i_1}) = \frac{1}{\sigma \sqrt{2 \pi}}e^{- \frac{(x'_{i_1} - x_{i_1})^2}{2 \sigma^2}}
$.

Считая значения этих различий по координатам и по точкам независимым, получаем

$
    \mathbb{P}(x_1, ..., x_n | T) = \prod\limits_{i = 1}^n \mathbb{P}(x_{i_1} - x'_{i_1})\mathbb{P}(x_{i_2} - x'_{i_2})
$

Функция энергии получается логарифмированием этой вероятности и взятием её с
минусом:

$
    E_{feat} =
        - \log(\mathbb{P}(x_1, ..., x_n | T)) = 
        - \log(\prod\limits_{i = 1}^n \mathbb{P}(x_{i_1} - x'_{i_1}) \mathbb{P}(x_{i_2} - x'_{i_2})) =  - \sum\limits_{i = 1}^{n}( \mathbb{P}(x_{i_1} - x'_{i_1}) + \mathbb{P}(x_{i_2} - x'_{i_2}))
$

Функция энергии цветового трекинга описана в главе 2.3. % TODO: ref

Общая функция ошибки является взвешенной суммой ошибок цветового метода и
метода ключевых точек. 

$E = E_{color} + \alpha E_{feat}$

Коэффициент $\alpha$ меняется в ходе трекинга.

В первый раз функция ошибки может быть вычислена на втором кадре:

$E^{(2)} = E_{color}^{(2)} + \alpha_2 E_{feat}^{(2)}$

При этом запоминается соотношение $E_{color}^{(2)}$ и $E_{feat}^{(2)}$:

$\beta^{(2)} = \frac{E_{color}^{(2)}}{E_{feat}^{(2)}}$
,
В дальнейшем качество одного из видов трекинга может ухудшиться, и в этом
случае его вес в общей сумме должен уменьшиться.

В предлагаемом методе $\alpha_i = \alpha_2 * \frac{\beta_{i - 1}}{\beta_2}$ для $i > 2$.

$\alpha_i = \alpha_0 \frac{E_{color}}{E_{feat}}$

$\alpha_2$ задаётся явно и принято равным ...

Оптимизация проводится методом SLSQP, якобиан функции также является взвешенной
суммой якобианов:

$J = J_{color} + \alpha J_{feat}$
