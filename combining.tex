\section{Скрещивание методов}

\subsection{Последовательное применение алгоритмов}
Первый способ скрещивания алгоритмов заключается в последовательном их применении и инициализации одного метода другим. Метод на основе распределения цветов требует пересчёта большого количества гистограмм и использования их при каждом вычислении функции ошибки и градиента, поэтому является более вычислительно сложным, чем метод ключевых точек, поэтому для скорости трекинга важно сократить количество итераций, за которое он сходится.

Позиции объекта на видео определяются последовательно, от кадра к кадру. Введём обозначения:

$F_{feat}(I)$ -- результат работы алгоритма ключевых точек на изображении $I$; 

$F_{color}(T, I)$ -- результат работы цветового алгоритма на изображении $I$ при инициализации его позицией $T$;

$E_{color}(T)$ -- функция энергии цветового алгоритма от позиции $T$.

Тогда при обработке $i$-ого кадра проводится следующая последовательность действий:

\begin{enumerate}
\item Чтение изображения $I_i$
\item Вычиление позиции алгоритмом ключевых точек: $T_{feat}^{(i)} = F_{feat}(I_i)$
\item Уточнение позиции цветовым методом: $T^{(i)} = F_{color}(T_{feat}, I_i)$
\item Вычисление  3D-позиций, соответствующих ключевым особенностям с использованием позиции $T^i$
\end{enumerate}

После получения изображения проиходит вычисление позиции $T_{feat}$ алгоритмом ключевых точек, описанным в главе 2.2.  Чаще всего эта позиция близка к глобальному минимуму функции энергии цветового алгоритма, но если метод ключевых точек отработал плохо (например из-за смазанности изображения), то эта позиция может оказаться далеко от оптимума, и из-за этого цветовой алгоритм может не сойтись. Чтобы избежать таких случаев, предусмотрен альтернативный способ инициализации позиции. 

Наиболее естественный способ инициализировать алгоритм трекинга при отсутствии специального метода инициализации -- это взять позицию с предыдущего кадра. Но очень часто неправильная работа трекинга на ключевых точках вызвана смазанностью при быстром движении объекта. Чтобы учесть это движение, мы вычисляем альтернативную позицию экстраполяцией движения с предыдущих кадров: $T^{(i)}_{ex} = \Delta T T^{(i - 1)} = T^{(i - 1)}(T^{(i - 2)})^{-1} T^{(i - 1)}$.

Алгоритм цветового трекинга сам выбирает, какую позицию использовать для инициализации. Выбирается та из них, на которой функция энергии цветового алгоритма будет меньше. $T_{color_init} = argmin(E_{color}(T_{feat}), E_{color}(T_{ex}))$.

Чтобы этот выбор не занимал слишком много времени, вычисление $E_{color}$ здесь проводится на 1\% гистограмм.

Для каждой отслеживаемой ключевой особенности известна её 3D-позиция на объекте. Для ключевых особенностей, которые впервые появились на текущем кадре, требуется эту позицию найти. Так как матрица трансформации, полученная цветовым алгоритмом, считается уточнением матрицы, полученной алгоритмом ключевых точек, именно она используется для восстановления 3D-позиций.

\Comment{TODO: процесс восстановления 3D-позиций?}

Для точечных особенностей, которые присутствовали и на предыдущих кадрах, 3D-позиция на объекте известна. Однако то положение объекта, на котором она была вычислена, могло оказаться неверным, и тогда 3D-позиция точки также вычислено неправильно. Эта ошибка сохраняется в течение всего времени, пока данная точечная особенность отслеживается. Чтобы уточнить такие 3D-точки, все они пересчитываются на новом кадре, и если новая позиция оказалась лучше, то она заменяет старую.

Чтобы определить, какая позиция лучше, нужно оценить ошибку репроекции для каждой позиции. Но ошибка репроекции будет нулевой для кадра, по которому позиция вычислена, поэтому нужно выбрать какой-то кадр, на котором обе ошибки будут отличны от нуля. Вопрос об обновлении позиции откладывается до следующего кадра, и решается уже по репроекции на нём. 

Пусть $T_{old}$ - трансформация, на которой была вычислена позиция $X_{old}$, $T_{new}$ - трансформация, на которой была вычислена позиция $X_{new}$, $new > old$.

Пусть $x_0$ - позиция точечной особенности на изображении $new + 1$. 

Тогда $x_{old} = \pi (K (T_{new + 1})_{3 \times 4} X_{old})$

$x_{new} = \pi (K (T_{new + 1})_{3 \times 4} X_{new})$

$e_{old} = \| x_{old} - x_0 \|$

$e_{new} = \| x_{new} - x_0 \|$

При $e_{new} < e_{old}$ позиция $X_{old}$ заменяется на $X_{new}$.

\subsection{Совместная оптимизация}
